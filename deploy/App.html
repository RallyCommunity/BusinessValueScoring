<!DOCTYPE html>
<html>
<head>
    <title>Random App Name17656</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var Ext=window.Ext4||window.Ext;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var that=this;that.TimeCriticalityField=that.getSetting("TimeCriticalityField"),that.RROEValueField=that.getSetting("RROEValueField"),that.UserBusinessValueField=that.getSetting("UserBusinessValueField"),that.WSJFScoreField=that.getSetting("WSJFScoreField"),that.JobSizeField=that.getSetting("JobSizeField"),that.ShowValuesAfterDecimal=that.getSettingsFields("ShowValuesAfterDecimal"),that.calculatedFields=that._getCalculatedFields(),that.Weightings=JSON.parse(that.getSetting("Weightings")),that.ValueMappings=JSON.parse(that.getSetting("ValueMappings")),console.log("w",that.Weightings),console.log("v",that.ValueMappings),this._grid=null,this._piCombobox=this.add({xtype:"rallyportfolioitemtypecombobox",padding:5,listeners:{select:this._onPICombobox,scope:this}})},_getCalculatedFields:function(){var settingName="CalculatedField",cfs=[];for(x=1;2>=x;x++){var fieldText=this.getSetting("CalculatedField"+x),calcField={};if(!_.isUndefined(fieldText)&&!_.isNull(fieldText)&&""!=fieldText){var parts=fieldText.split(",");calcField.field=parts[0],calcField.formula=parts[1],cfs.push(calcField)}}return cfs},_getWeightings:function(){return this.Weightings},_getValueMappings:function(){return this.ValueMappings},_isMappableField:function(fieldName,record){var value=record.get(fieldName);return _.isNull(value)||""==value||_.isNumber(value)||!_.isNaN(parseInt(""+value))?!1:!0},_mapValue:function(value,field){console.log("mapping",value,field);var mappings=this._getValueMappings(),key=_.has(mappings,field)?field:"default";console.log("key",key);var mapping=mappings[key];return console.log("mapping",mapping,mapping[value]),_.has(mapping,value)?mapping[value]:0},_applyWeigthing:function(fieldName,value){var weightings=this._getWeightings();return _.has(weightings,fieldName)?value*weightings[fieldName]:value},_calcValue:function(record,calcField){var that=this,regex=/\w{2,50}/g,replacer=function(fieldName){var value;return value=that._isMappableField(fieldName,record)?that._mapValue(record.get(fieldName),fieldName):record.get(fieldName),that._applyWeigthing(fieldName,value)},formula=calcField.formula.replace(regex,replacer),value;try{value=eval(formula)}catch(e){return{value:0,error:e.message}}return console.log("formula:",formula,"value",value),{value:value,error:null}},_onPICombobox:function(){var selectedType=this._piCombobox.getRecord(),model=selectedType.get("TypePath");null!==this._grid&&this._grid.destroy(),Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:[model],listeners:{load:function(store){var records=store.getRootNode().childNodes;this._calculateScore(records)},update:function(store,rec,modified,opts){this._calculateScore([rec])},scope:this},enableHierarchy:!0}).then({success:this._onStoreBuilt,scope:this})},_onStoreBuilt:function(store,records){var selectedType=this._piCombobox.getRecord(),modelNames=selectedType.get("TypePath"),columns=["Name"],context=this.getContext();this._grid=this.add({xtype:"rallygridboard",context:context,modelNames:[modelNames],toggleState:"grid",stateful:!1,plugins:[{ptype:"rallygridboardcustomfiltercontrol",filterChildren:!1,filterControlConfig:{modelNames:[modelNames],stateful:!0,stateId:context.getScopedStateId("custom-filter-example")}},{ptype:"rallygridboardfieldpicker",headerPosition:"left",modelNames:[modelNames],stateful:!0,stateId:context.getScopedStateId("columns-example")},{ptype:"rallygridboardactionsmenu",menuItems:[{text:"Export...",handler:function(){window.location=Rally.ui.grid.GridCsvExport.buildCsvExportUrl(this.down("rallygridboard").getGridOrBoard())},scope:this}],buttonConfig:{iconCls:"icon-export"}}],gridConfig:{store:store,columnCfgs:columns},height:this.getHeight()})},_calculateScore:function(records){var that=this;Ext.Array.each(records,function(feature){_.each(that.calculatedFields,function(calcField){var value=that._calcValue(feature,calcField);_.isNull(value.error)?feature.set(calcField.field,value.value):console.log("formula error:",value.error)})})},getSettingsFields:function(){var values=[{name:"CalculatedField1",width:800,xtype:"rallytextfield",label:"Calculated Field 1",labelWidth:200},{name:"CalculatedField2",width:800,xtype:"rallytextfield",label:"Calculated Field 2",labelWidth:200},{name:"ValueMappings",width:800,xtype:"textareafield",grow:!0,label:"Field Value Mappings",labelWidth:200},{name:"Weightings",width:800,xtype:"textareafield",grow:!0,label:"Field Value Weightings",labelWidth:200}];return values},config:{defaultSettings:{ValueMappings:_getValueMappingsString(),Weightings:_getWeightingsString(),CalculatedField1:"",CalculatedField2:""}}});
                function _getValueMappingsString(){return'{\n            "default" : {\n                "NA" : 0,\n                "L" : 1,\n                "M" : 5,\n                "H" : 10\n            },\n            "c_RiskFactorOfNotDoing" : {\n                "NA" : 0,\n                "L"  : 5,\n                "M"  : 10,\n                "H"  : 25\n            },\n            "c_Foundational" : {\n                "NA" : 0,\n                "L"  : 5,\n                "M"  : 10,\n                "H"  : 25\n            },\n            "c_BusinessLevelOfEffort" : {\n                "NA" :  0,\n                "XS" :  1,\n                "S"  :  2,\n                "M"  :  3,\n                "L"  :  5,\n                "XL" :  8\n            },\n            "c_ITLevelOfEffort" : {\n                "NA" :  0,\n                "XS" :  1,\n                "S"  :  2,\n                "M"  :  3,\n                "L"  :  5,\n                "XL" :  8\n            }\n        }\n'}function _getWeightingsString(){return'{\n            "c_SalesProfitability" : 4.8,\n            "c_CostSavings" : 1.7,\n            "c_CustomerExperience" : 3.4,\n            "c_AgentExperience" : 2.2,\n            "c_RiskMitigationCompliance" : 2.9,\n            "c_Urgency" : 1,\n            "c_RiskFactorOfNotDoing" : 1,\n            "c_Foundational" : 1\n        }\n'}

            Rally.launchApp('CustomApp', {
                name:"Random App Name17656",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
